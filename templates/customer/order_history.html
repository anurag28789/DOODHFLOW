{% extends "base.html" %}
{% block title %}Order History - {{ customer.name }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

<style>
    body {
        background-color: #f8f9fa;
    }
    .profile-header {
        background: linear-gradient(45deg, #0d6efd, #6c757d);
        color: #fff;
        padding: 2rem;
        border-radius: 0.75rem;
        margin-bottom: 2rem;
    }
    .filter-section {
        background-color: #fff;
        padding: 1rem;
        border-radius: 0.75rem;
        border: 1px solid #e9ecef;
        margin-bottom: 1.5rem;
    }
    .history-card {
        display: flex;
        align-items: center;
        background-color: #fff;
        border: 1px solid #e9ecef;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        padding: 1rem;
        transition: box-shadow 0.2s ease-in-out;
    }
    .history-card:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.07);
    }
    .history-card .date-block {
        text-align: center;
        margin-right: 1.5rem;
        padding-right: 1.5rem;
        border-right: 1px solid #e9ecef;
        min-width: 100px;
    }
    .history-card .date-block .day {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
    }
    .history-card .date-block .month-year {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .history-card .details {
        flex-grow: 1;
        display: flex;
        justify-content: space-around;
        align-items: center;
    }
    .history-card .detail-item {
        text-align: center;
    }
    .history-card .detail-item .item-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
    }
    .history-card .detail-item .item-value {
        font-weight: 500;
    }
    .history-card .actions {
        min-width: 150px;
        text-align: right;
    }
    .checkbox-col {
        padding-right: 1rem;
    }
    .bg-danger-light {
        background-color: #f8d7da;
    }
    .text-danger-dark {
        color: #842029;
    }
    .bg-success-light {
        background-color: #d1e7dd;
    }
    .text-success-dark {
        color: #0f5132;
    }
</style>

<div class="container mt-4">
    <div class="profile-header d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-1">Order History</h2>
            <p class="mb-0">Viewing records for {{ customer.name }}</p>
        </div>
        <div class="d-flex gap-2">
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="downloadMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-download me-2"></i>Download Report
                </button>
                <ul class="dropdown-menu" aria-labelledby="downloadMenuButton">
                    <li><a class="dropdown-item" href="{{ url_for('download_order_report', customer_id=customer.id, status='all') }}">All Orders (CSV)</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('download_order_report', customer_id=customer.id, status='paid') }}">Paid Orders (CSV)</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('download_order_report', customer_id=customer.id, status='unpaid') }}">Unpaid Orders (CSV)</a></li>
                </ul>
            </div>
            {% if current_user.role in ['milkman', 'admin'] %}
                <a href="{{ url_for('manage_customers') }}" class="btn btn-light"><i class="fas fa-arrow-left me-2"></i>Back</a>
            {% else %}
                <a href="{{ url_for('customer_dashboard') }}" class="btn btn-light"><i class="fas fa-arrow-left me-2"></i>Back</a>
            {% endif %}
        </div>
    </div>

    <div class="card filter-section">
        <form method="get" class="row g-3 align-items-center">
            <div class="col-md-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" id="startDate" name="start_date" class="form-control" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" id="endDate" name="end_date" class="form-control" value="{{ end_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Session</label>
                <select name="session" class="form-select">
                    <option value="" {% if not session_name %}selected{% endif %}>All Sessions</option>
                    <option value="morning" {% if session_name == 'morning' %}selected{% endif %}>Morning</option>
                    <option value="evening" {% if session_name == 'evening' %}selected{% endif %}>Evening</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="" {% if not status_filter %}selected{% endif %}>All Statuses</option>
                    <option value="paid" {% if status_filter == 'paid' %}selected{% endif %}>Paid</option>
                    <option value="unpaid" {% if status_filter == 'unpaid' %}selected{% endif %}>Unpaid</option>
                </select>
            </div>
            <div class="col-12 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </form>
    </div>

    {% if current_user.role in ['milkman', 'admin'] %}
    <form method="POST" action="{{ url_for('generate_customer_bill', customer_id=customer.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% endif %}

    {% for order in orders %}
    <div class="history-card">
        {% if current_user.role in ['milkman', 'admin'] %}
        <div class="checkbox-col">
            {% if order.status == 'unpaid' %}
                <input class="form-check-input" type="checkbox" name="requirement_ids" value="{{ order.id }}">
            {% endif %}
        </div>
        {% endif %}
        <div class="date-block">
            <div class="day">{{ order.date_requested.strftime('%d') }}</div>
            <div class="month-year">{{ order.date_requested.strftime('%b %Y') }}</div>
        </div>
        <div class="details">
            <div class="detail-item text-center">
                <div class="item-label">Cow Milk</div>
                <div class="item-value">{{ order.cow_qty or 0 }} L</div>
            </div>
            <div class="detail-item text-center">
                <div class="item-label">Buffalo Milk</div>
                <div class="item-value">{{ order.buffalo_qty or 0 }} L</div>
            </div>
            <div class="detail-item text-center">
                <div class="item-label">Status</div>
                <div class="item-value">
                    <span class="badge rounded-pill {% if order.status == 'paid' %}bg-success-light text-success-dark{% else %}bg-danger-light text-danger-dark{% endif %}">
                        {{ order.status|capitalize }}
                    </span>
                </div>
            </div>
            <div class="detail-item text-center">
                {% set total = ((order.cow_qty or 0) * (order.cow_rate_at_order or 0)) + ((order.buffalo_qty or 0) * (order.buffalo_rate_at_order or 0)) %}
                <div class="item-label">Total Amount</div>
                <div class="item-value fw-bold text-success">â‚¹{{ "%.2f"|format(total) }}</div>
            </div>
        </div>
        <div class="actions">
            {% if current_user.role in ['milkman', 'admin'] and order.status == 'unpaid' %}
            <form method="POST" action="{{ url_for('mark_order_paid', order_id=order.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-success btn-sm">Mark Paid</button>
            </form>
            {% elif order.status == 'paid' and order.payments %}
            <a href="{{ url_for('customer_view_bill', payment_id=order.payments[0].id) }}" class="btn btn-info btn-sm">View Bill</a>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="text-center p-5 bg-light rounded">
        <i class="fas fa-history fa-3x text-muted mb-3"></i>
        <h4>No Order History Found</h4>
        <p class="text-muted">There are no records matching your filter criteria.</p>
    </div>
    {% endfor %}

    {% if current_user.role in ['milkman', 'admin'] and orders %}
    <div class="mt-4 text-end">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-receipt me-2"></i>Generate Bill for Selected
        </button>
    </div>
    </form>
    {% endif %}
</div>
{% endblock %}